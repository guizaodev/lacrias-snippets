<!-- Adiciona Tailwind CSS via CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<div id="posts-from-rss">
  <h2>Últimas postagens</h2>
  <div id="posts-list">Carregando...</div>
</div>

<script>
(async function(){
  const urlParams = new URLSearchParams(window.location.search);
  const category = urlParams.get('category') || 'noticias-internas';
  
  // Adiciona timestamp para evitar cache do proxy
  const timestamp = new Date().getTime();
  const feedUrl = `https://laboratorios.ufpr.br/lacrias/category/${category}/feed/?t=${timestamp}`;
  const proxy = 'https://corsproxy.io/?' + encodeURIComponent(feedUrl);
  const maxPosts = 6;

  function stripHtml(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html || '';
    return tmp.textContent || tmp.innerText || '';
  }

  try {
    const res = await fetch(proxy);
    if (!res.ok) throw new Error('Erro: ' + res.status);
    
    const xmlText = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, 'application/xml');

    const items = Array.from(xml.querySelectorAll('item')).slice(0, maxPosts);

    if (!items.length) {
      document.getElementById('posts-list').innerHTML = '<p>Nenhuma notícia encontrada.</p>';
      return;
    }

    const ul = document.createElement('ul');
    ul.className = 'list-none p-0';

    items.forEach(item => {
      console.log(item);
      
      // Captura todas as propriedades do XML
      const title = item.querySelector('title')?.textContent || 'Sem título';
      const link = item.querySelector('link')?.textContent || '#';
      const comments = item.querySelector('comments')?.textContent || '';
      const pubDate = item.querySelector('pubDate')?.textContent || '';
      const category = item.querySelector('category')?.textContent || 'Sem categoria';
      const guid = item.querySelector('guid')?.textContent || '';
      const description = item.querySelector('description')?.textContent || '';
      const contentEncoded = item.querySelector('content\\:encoded')?.textContent || description;
      const commentRss = item.querySelector('wfw\\:commentRss')?.textContent || '';
      const commentsCount = item.querySelector('slash\\:comments')?.textContent || '0';
      
      // Usa getElementsByTagNameNS para pegar o elemento com namespace correto
      const creatorElement = item.getElementsByTagNameNS('http://purl.org/dc/elements/1.1/', 'creator')[0];
      const author = creatorElement?.textContent || 'Autor Desconhecido';
      
      console.log('Author:', author);
      
      // Pega iniciais do primeiro e último nome
      const names = author.split(' ').filter(n => n.length > 0);
      const authorInitials = names.length > 1 
        ? (names[0][0] + names[names.length - 1][0]).toUpperCase()
        : names[0]?.substring(0, 2).toUpperCase() || 'AD';
      
      let img = null;
      if (contentEncoded) {
        const tmp = document.createElement('div');
        tmp.innerHTML = contentEncoded;
        const imgEl = tmp.querySelector('img');
        img = imgEl ? imgEl.src : null;
      }

      const li = document.createElement('li');
      li.className = 'mb-3';
      li.innerHTML = `
        <article class="group bg-white rounded-xl border border-stone-200 hover:border-emerald-300 hover:shadow-md transition-all duration-300">
          <a href="${link}" target="_top" class="block p-5">
            <div class="flex flex-col gap-3">
              <!-- Category & Date -->
              <div class="flex items-center justify-between">
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">
                ${category}
                </span>
                <time datetime="${pubDate}" class="text-sm text-stone-400">${new Date(pubDate).toLocaleDateString('pt-BR')}</time>
              </div>
              
              ${img ? `
              <!-- Image -->
              <div class="w-full h-48 rounded-lg overflow-hidden">
                <img src="${img}" alt="${title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
              </div>
              ` : ''}
              
              <!-- Title -->
              <h2 class="text-lg font-semibold text-stone-900 group-hover:text-emerald-700 transition-colors">
                ${title}
              </h2>
              
              <!-- Description -->
              <p class="text-stone-500 text-sm leading-relaxed">
                ${stripHtml(contentEncoded).slice(0,150)}${stripHtml(contentEncoded).length>150?'…':''}
              </p>
              
              <!-- Footer: Author & Comments -->
              <div class="flex items-center justify-between pt-2 border-t border-stone-100">
                <div class="flex items-center gap-2">
                  <div class="w-7 h-7 rounded-full bg-emerald-100 flex items-center justify-center">
                    <span class="text-xs font-medium text-emerald-700">${authorInitials}</span>
                  </div>
                  <span class="text-sm text-stone-600">${author}</span>
                </div>
                <div class="flex items-center gap-1.5 text-stone-400">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                  <span class="text-sm">${commentsCount}</span>
                </div>
              </div>
            </div>
          </a>
        </article>
      `;
      ul.appendChild(li);
    });

    const container = document.getElementById('posts-list');
    container.innerHTML = '';
    container.appendChild(ul);

  } catch (err) {
    console.error(err);
    document.getElementById('posts-list').innerHTML = '<p>Erro ao carregar o feed. Tente novamente mais tarde.</p>';
  }
})();
</script>