<!-- Adiciona Tailwind CSS via CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<div id="posts-from-rss">
  <h2>Últimas postagens</h2>
  <div id="posts-list">Carregando...</div>
</div>

<script>
(async function(){
  const urlParams = new URLSearchParams(window.location.search);
  const category = urlParams.get('category') || 'noticias-internas';
  
  // Adiciona timestamp para evitar cache do proxy
  const timestamp = new Date().getTime();
  const feedUrl = `https://laboratorios.ufpr.br/lacrias/category/${category}/feed/?t=${timestamp}`;
  const proxy = 'https://corsproxy.io/?' + encodeURIComponent(feedUrl);
  const maxPosts = 6;

  function stripHtml(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html || '';
    return tmp.textContent || tmp.innerText || '';
  }

  try {
    const res = await fetch(proxy);
    if (!res.ok) throw new Error('Erro: ' + res.status);
    
    const xmlText = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, 'application/xml');

    const items = Array.from(xml.querySelectorAll('item')).slice(0, maxPosts);

    if (!items.length) {
      document.getElementById('posts-list').innerHTML = '<p>Nenhuma notícia encontrada.</p>';
      return;
    }

    const ul = document.createElement('ul');
    ul.className = 'list-none p-0';

    items.forEach(item => {
      const title = item.querySelector('title')?.textContent || 'Sem título';
      const link = item.querySelector('link')?.textContent || '#';
      const pubDate = item.querySelector('pubDate')?.textContent;
      const contentEncoded = item.querySelector('content\\:encoded')?.textContent || item.querySelector('description')?.textContent || '';
      
      let img = null;
      if (contentEncoded) {
        const tmp = document.createElement('div');
        tmp.innerHTML = contentEncoded;
        const imgEl = tmp.querySelector('img');
        img = imgEl ? imgEl.src : null;
      }

      const li = document.createElement('li');
      li.className = 'mb-3';
      li.innerHTML = `
        <a href="${link}" class="flex gap-2.5 items-center no-underline text-inherit hover:opacity-80 transition-opacity">
          ${img ? `<img src="${img}" alt="${title}" class="w-21 h-15 object-cover rounded-md flex-shrink-0">` : ''}
          <div>
            <div class="font-semibold">${title}</div>
            ${pubDate ? `<div class="text-xs text-gray-600">${new Date(pubDate).toLocaleDateString('pt-BR')}</div>` : ''}
            <div class="text-sm text-gray-700">${stripHtml(contentEncoded).slice(0,120)}${stripHtml(contentEncoded).length>120?'…':''}</div>
          </div>
        </a>
      `;
      ul.appendChild(li);
    });

    const container = document.getElementById('posts-list');
    container.innerHTML = '';
    container.appendChild(ul);

  } catch (err) {
    console.error(err);
    document.getElementById('posts-list').innerHTML = '<p>Erro ao carregar o feed. Tente novamente mais tarde.</p>';
  }
})();
</script>