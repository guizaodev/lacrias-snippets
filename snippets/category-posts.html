<div id="posts-from-rss">
  <h2>Últimas postagens</h2>
  <div id="posts-list">Carregando...</div>
</div>

<script>
(async function(){
  const urlParams = new URLSearchParams(window.location.search);
  const category = urlParams.get('category') || 'noticias-internas';
  
  // Adiciona timestamp para evitar cache do proxy
  const timestamp = new Date().getTime();
  const feedUrl = `https://laboratorios.ufpr.br/lacrias/category/${category}/feed/?t=${timestamp}`;
  const proxy = 'https://corsproxy.io/?' + encodeURIComponent(feedUrl);
  const maxPosts = 6;

  function stripHtml(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html || '';
    return tmp.textContent || tmp.innerText || '';
  }

  try {
    const res = await fetch(proxy);
    if (!res.ok) throw new Error('Erro: ' + res.status);
    
    const xmlText = await res.text();
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlText, 'application/xml');

    const items = Array.from(xml.querySelectorAll('item')).slice(0, maxPosts);

    if (!items.length) {
      document.getElementById('posts-list').innerHTML = '<p>Nenhuma notícia encontrada.</p>';
      return;
    }

    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = '0';

    items.forEach(item => {
      const title = item.querySelector('title')?.textContent || 'Sem título';
      const link = item.querySelector('link')?.textContent || '#';
      const pubDate = item.querySelector('pubDate')?.textContent;
      const contentEncoded = item.querySelector('content\\:encoded')?.textContent || item.querySelector('description')?.textContent || '';
      
      let img = null;
      if (contentEncoded) {
        const tmp = document.createElement('div');
        tmp.innerHTML = contentEncoded;
        const imgEl = tmp.querySelector('img');
        img = imgEl ? imgEl.src : null;
      }

      const li = document.createElement('li');
      li.style.marginBottom = '12px';
      li.innerHTML = `
        <a href="${link}" style="display:flex; gap:10px; align-items:center; text-decoration:none; color:inherit;">
          ${img ? `<img src="${img}" alt="${title}" style="width:84px;height:60px;object-fit:cover;border-radius:6px;">` : ''}
          <div>
            <div style="font-weight:600;">${title}</div>
            ${pubDate ? `<div style="font-size:12px;color:#666;">${new Date(pubDate).toLocaleDateString('pt-BR')}</div>` : ''}
            <div style="font-size:13px;color:#444;">${stripHtml(contentEncoded).slice(0,120)}${stripHtml(contentEncoded).length>120?'…':''}</div>
          </div>
        </a>
      `;
      ul.appendChild(li);
    });

    const container = document.getElementById('posts-list');
    container.innerHTML = '';
    container.appendChild(ul);

  } catch (err) {
    console.error(err);
    document.getElementById('posts-list').innerHTML = '<p>Erro ao carregar o feed. Tente novamente mais tarde.</p>';
  }
})();
</script>