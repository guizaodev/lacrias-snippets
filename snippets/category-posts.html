<!-- Adiciona Tailwind CSS via CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<div id="posts-from-api">
  <h2>Últimas postagens</h2>
  <div id="posts-list">Carregando...</div>
  <div id="pagination-container"></div>
</div>

<script>
(async function(){
  const urlParams = new URLSearchParams(window.location.search);
  const categorySlug = urlParams.get('category') || 'noticias-internas';
  
  const baseUrl = 'https://laboratorios.ufpr.br/lacrias/wp-json/wp/v2';
  
  // Variáveis de controle
  let categoryId = null;
  let currentPage = 1;
  let itemsPerPage = 10;
  let totalPosts = 0;
  let totalPages = 0;
  let isLoading = false;

  function stripHtml(html){
    const tmp = document.createElement('div');
    tmp.innerHTML = html || '';
    return tmp.textContent || tmp.innerText || '';
  }

  // Busca o ID da categoria pelo slug
  async function getCategoryId() {
    try {
      const response = await fetch(`${baseUrl}/categories?slug=${categorySlug}`);
      if (!response.ok) throw new Error('Erro ao buscar categoria');
      
      const categories = await response.json();
      if (!categories.length) {
        throw new Error('Categoria não encontrada');
      }
      
      return categories[0].id;
    } catch (error) {
      console.error('Erro ao buscar categoria:', error);
      throw error;
    }
  }

  // Busca os posts da categoria
  async function fetchPosts() {
    if (isLoading) return;
    isLoading = true;

    try {
      const response = await fetch(
        `${baseUrl}/posts?categories=${categoryId}&per_page=${itemsPerPage}&page=${currentPage}&_embed`
      );
      
      if (!response.ok) {
        if (response.status === 400) {
          throw new Error('Página inválida');
        }
        throw new Error('Erro ao buscar posts');
      }
      
      // Pega o total de posts e páginas do header
      totalPosts = parseInt(response.headers.get('X-WP-Total') || '0');
      totalPages = parseInt(response.headers.get('X-WP-TotalPages') || '0');
      
      const posts = await response.json();
      
      if (!posts.length && currentPage === 1) {
        // Redireciona se não houver posts
        const errorUrl = 'https://guizaodev.github.io/lacrias-snippets/snippets/error-psita.html?code=204&title=Oops%2C+ainda+não+há+posts+nessa+categoria';
        window.location.href = errorUrl;
        return;
      }
      
      renderPosts(posts);
      renderPagination();
      
    } catch (error) {
      console.error('Erro ao carregar posts:', error);
      document.getElementById('posts-list').innerHTML = '<p>Erro ao carregar os posts. Tente novamente mais tarde.</p>';
    } finally {
      isLoading = false;
    }
  }

  function renderPosts(posts) {
    const ul = document.createElement('ul');
    ul.className = 'list-none p-0';

    posts.forEach(post => {
      // Extrai dados do post
      const title = post.title.rendered || 'Sem título';
      const link = post.link || '#';
      const pubDate = post.date || '';
      const excerpt = post.excerpt.rendered || '';
      const content = post.content.rendered || '';
      
      // Categoria principal
      const categoryName = post._embedded?.['wp:term']?.[0]?.[0]?.name || 'Sem categoria';
      
      // Autor
      const author = post._embedded?.author?.[0]?.name || 'Autor Desconhecido';
      
      // Pega iniciais do primeiro e último nome
      const names = author.split(' ').filter(n => n.length > 0);
      const authorInitials = names.length > 1 
        ? (names[0][0] + names[names.length - 1][0]).toUpperCase()
        : names[0]?.substring(0, 2).toUpperCase() || 'AD';
      
      // Imagem destacada
      const featuredImage = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || null;
      
      // Número de comentários
      const commentsCount = post.comment_count || 0;

      const li = document.createElement('li');
      li.className = 'mb-3';
      li.innerHTML = `
        <article class="group bg-white rounded-xl border border-stone-200 hover:border-emerald-300 hover:shadow-md transition-all duration-300">
          <a href="${link}" target="_top" class="block p-5">
            <div class="flex flex-col gap-3">
              <!-- Category & Date -->
              <div class="flex items-center justify-between">
                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">
                  ${categoryName}
                </span>
                <time datetime="${pubDate}" class="text-sm text-stone-400">${new Date(pubDate).toLocaleDateString('pt-BR')}</time>
              </div>
              
              ${featuredImage ? `
              <!-- Image -->
              <div class="w-full h-48 rounded-lg overflow-hidden">
                <img src="${featuredImage}" alt="${title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
              </div>
              ` : ''}
              
              <!-- Title -->
              <h2 class="text-lg font-semibold text-stone-900 group-hover:text-emerald-700 transition-colors">
                ${title}
              </h2>
              
              <!-- Description -->
              <p class="text-stone-500 text-sm leading-relaxed">
                ${stripHtml(excerpt || content).slice(0,150)}${stripHtml(excerpt || content).length>150?'…':''}
              </p>
              
              <!-- Footer: Author & Comments -->
              <div class="flex items-center justify-between pt-2 border-t border-stone-100">
                <div class="flex items-center gap-2">
                  <div class="w-7 h-7 rounded-full bg-emerald-100 flex items-center justify-center">
                    <span class="text-xs font-medium text-emerald-700">${authorInitials}</span>
                  </div>
                  <span class="text-sm text-stone-600">${author}</span>
                </div>
                <div class="flex items-center gap-1.5 text-stone-400">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                  <span class="text-sm">${commentsCount}</span>
                </div>
              </div>
            </div>
          </a>
        </article>
      `;
      ul.appendChild(li);
    });

    const container = document.getElementById('posts-list');
    container.innerHTML = '';
    container.appendChild(ul);
  }

  function renderPagination() {
    const paginationContainer = document.getElementById('pagination-container');

    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    let paginationHTML = `
      <nav aria-label="Page navigation" class="flex items-center justify-center space-x-4 mt-6">
        <div class="flex items-center h-9">
          <ul class="flex -space-x-px text-sm">
          <li>
            <a href="#" data-page="${currentPage - 1}" class="flex items-center justify-center text-body bg-neutral-secondary-medium border border-default-medium hover:bg-neutral-tertiary-medium hover:text-heading shadow-xs font-medium leading-5 rounded-s-base text-sm px-3 h-9 focus:outline-none ${currentPage === 1 ? 'opacity-50 pointer-events-none' : ''}">Anterior</a>
          </li>
    `;

    for (let i = startPage; i <= endPage; i++) {
      const isActive = i === currentPage;
      paginationHTML += `
        <li>
          <a href="#" data-page="${i}" ${isActive ? 'aria-current="page"' : ''} class="flex items-center justify-center ${isActive ? 'text-fg-brand bg-neutral-tertiary-medium box-border border border-default-medium hover:text-fg-brand' : 'text-body bg-neutral-secondary-medium border border-default-medium hover:bg-neutral-tertiary-medium hover:text-heading shadow-xs'} font-medium text-sm w-9 h-9 focus:outline-none">${i}</a>
        </li>
      `;
    }

    paginationHTML += `
          <li>
            <a href="#" data-page="${currentPage + 1}" class="flex items-center justify-center text-body bg-neutral-secondary-medium border border-default-medium hover:bg-neutral-tertiary-medium hover:text-heading shadow-xs font-medium leading-5 rounded-e-base text-sm px-3 h-9 focus:outline-none ${currentPage === totalPages ? 'opacity-50 pointer-events-none' : ''}">Próximo</a>
          </li>
        </ul>
        </div>
        <div class="flex flex-col items-center h-9">
          <form class="w-32">
            <label for="items-per-page" class="sr-only">Select an option</label>
            <select id="items-per-page" class="block w-full h-9 px-3 bg-neutral-secondary-medium border border-default-medium text-heading text-sm leading-4 rounded-base focus:ring-brand focus:border-brand shadow-xs placeholder:text-body">
              <option value="5" ${itemsPerPage === 5 ? 'selected' : ''}>5 por página</option>
              <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10 por página</option>
              <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>25 por página</option>
            </select>
          </form>
        </div>
      </nav>
    `;

    paginationContainer.innerHTML = paginationHTML;

    // Event listeners para paginação
    paginationContainer.querySelectorAll('a[data-page]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = parseInt(link.getAttribute('data-page'));
        if (page >= 1 && page <= totalPages && page !== currentPage) {
          currentPage = page;
          fetchPosts();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });
    });

    // Event listener para items per page
    const selectElement = paginationContainer.querySelector('#items-per-page');
    if (selectElement) {
      selectElement.addEventListener('change', (e) => {
        itemsPerPage = parseInt(e.target.value);
        currentPage = 1; // Reset para primeira página
        fetchPosts();
      });
    }
  }

  // Inicializa: busca o ID da categoria e depois os posts
  try {
    categoryId = await getCategoryId();
    await fetchPosts();
  } catch (error) {
    console.error('Erro na inicialização:', error);
    document.getElementById('posts-list').innerHTML = '<p>Erro ao inicializar. Verifique se a categoria existe.</p>';
  }
})();
</script>